# Convert OneNote to MarkDown

## Differences from Main Repository

1. Added a `$wrapCodeBlocks` config option to wrap OneNote code style text in
   backticks
1. Added a `$headerEnabled` config option to allow omitting the title of the
   note at the top of the document
1. Added a new option to the `$keepescape` config to allow escaping only opening
   or closing angle brackets
1. Updated the default `$conversion`, `$keepdocx`
   `$mdFileNameAndFolderNameMaxLength`, and `$medialocation` config values
1. Fixed output when `$headerTimestampEnabled` is disabled

## Prerequisites

If `$wrapCodeBlocks` is enabled, the following additional dependencies are
required:

1. [Python 3](https://www.python.org/downloads/) (>= v3.7)
1. [python-docx](https://python-docx.readthedocs.io/en/latest/) (v1.1.0)
   ```
   pip install python-docx==1.1.0
   ```

Before running, open PowerShell as Administrator and confirm the following
command runs successfully:

```powershell
python.exe -c "import docx"
```

## Running

1. Clone this Git repository
1. Rename `config.example.ps1` to `config.ps1`
1. Update `$notesdestpath` and `$targetNotebook` in `config.ps1` as needed
1. **â—IMPORTANT: Read the [Known Issues](#known-issues) section below as that
   will impact the `$keepescape` config option**. Set the `$keepescape` value
   appropriately after reading.
1. Open PowerShell as Administrator and `cd` to the cloned repository
1. Allow scripts to be executed for the current terminal:
   ```powershell
   Set-ExecutionPolicy Bypass -Scope Process -Force
   ```
1. Open OneNote as Administrator
1. Execute the script:
   ```powershell
   .\ConvertOneNote2MarkDown-v2.ps1
   ```

## Post-Run Cleanup Steps

The following steps should be run from a macOS or Linux system after the
generated notes have been copied off of the Windows system.

1. (Optional) Delete `docx` folder for each notebook if you no longer need the
   exported Word documents
1. Initialize a Git repository in the output folder containing your notebooks
   (this will solely be used to track the changes from each cleanup step)
1. Create a `.gitignore` and ignore the `docx/` and `.obsidian/` directories
1. Add all of the Markdown files from every notebook and commit the changes
1. Remove empty headers using `sed` and [this
   regex](https://regex101.com/r/8O0MMB/1)
    ```bash
    find . -name "*.md" -type f -exec sed -E -i.orig '/^#+ *$/d' {} \;
    ```
    ```bash
    find . -name "*.orig" -type f -exec rm -f {} \;
    ```
1. Review Git diff and commit changes
1. (Optional, but recommended) Remove alt text from images using `sed` and [this
   regex](https://regex101.com/r/wTB3VS/1). OneNote embeds OCR text into the alt
   text of images. If the OCR contains braces or other special characters, the
   image will not be rendered. For example: `![broken [OCR
   text]](assets/image.png)`
   ```bash
   find . -name "*.md" -type f -exec sed -E -i.orig 's/!\[.*\]\((.*)\)/![](\1)/g' {} \;
   ```
   ```bash
   find . -name "*.orig" -type f -exec rm -f {} \;
   ```
1. Review Git diff and commit changes
1. Remove `&nbsp;` lines using `sed` (these are inadvertently generated by
   pandoc)
   ```bash
   find . -name "*.md" -type f -exec sed -E -i.orig '/&nbsp;/d' {} \;
   ```
   ```bash
   find . -name "*.orig" -type f -exec rm -f {} \;
   ```
1. Review Git diff and commit changes
1. Install and run Prettier to delete extra newlines, trim trailing whitespace,
   and fix other miscellaneous formatting. I have noticed needing to run
   `prettier` up to 3 times until it is done making changes.
    ```bash
    npm install --save-dev --save-exact prettier && \
    echo "{}" > .prettierrc && \
    cp .gitignore .prettierignore
    ```
    ```bash
    npx prettier . --write
    ```
1. Review and commit changes
1. Continue running `prettier` and committing the changes until there is no more
   diff
1. Open Obsidian and point it to the output folder
1. Assuming the notes were generated with `$headerEnabled = 1`, disable
   `Settings -> Appearance -> Show inline title` in Obsidian to prevent a
   duplicate header from showing.

## Known Issues

1. In editing mode, the Obsidian Markdown rendering will break if the following
   conditions are true:
      1. There is a pair of opening/closing angle brackets outside of a code
         block (`<>`)
      1. There is text that is not a link in between the angle brackets

   Since Markdown is converted to HTML, this condition creates an invalid HTML
   tag. The issue is not exclusive to Obsidian and something similar will happen
   in Visual Studio Code. This is perfectly valid syntax in OneNote, but becomes
   invalid when converted to Markdown.

   > ðŸ’¡NOTE: The Markdown will still render in Obsidian **viewer** mode, but any
   > text that meets this condition will be hidden/removed. The same behavior
   > happens in Visual Studio Code.

   For example, the following text will break Obsidian Markdown rendering in
   editing mode:
   ```
   <here is some text>
   <a b c>
   ```
   However, this text will not because it contains a link and is considered
   valid HTML:
   ```
   <https://google.com>
   ```
   This scenario can be represented by [this
   regex](https://regex101.com/r/hFqTwv/5). To fix this, the angle brackets must
   be escaped:
   ```
   \<here is some text\>
   \<a b c\>
   ```
   Placing them in an inline code block is also a valid solution: `<a b c>`

   By default, `$keepescape = 1` will remove all escape characters generated by
   pandoc and the Obsidan Markdown rendering will break if the conditions
   described above are met. Alternatively, you can set `$keepescape = 3` to
   remove all escape characters besides those preceding opening/closing angle
   brackets. However, they will also be escaped in code blocks. For example, if
   there is a note with the following code block:
   ```
   <html></html>
   ```
   it will be converted to:
   ```
   \<html\>\</html\>
   ```
   If there is a note with the following code block:
   ```
   this.items.forEach((item) => {
      console.log(item)
   })
   ```
   it will be converted to:
   ```
   this.items.forEach((item) =\> {
      console.log(item)
   })
   ```
   There is currently no way to prevent the escaping of angle brackets in code
   blocks when `$keepescape = 3` because there is not an easy way to reliably
   determine if an angle bracket is code or normal text after the conversion.
   This is primarily an issue for HTML and CSS code blocks, but can appear in
   any language. You will need to choose the lesser of two evils based on your
   situation. To summarize the options:
      * `$keepescape = 1`
         * Pro: All escape characters are removed and angle brackets will not be
           escaped in code blocks
         * Con: Angle brackets will not be escaped in normal text which breaks
           the Obsidian Markdown rendering if the conditions described above are
           met
         * Fix: Manually add escape characters to any text that meets the
           conditions described above
      * `$keepescape = 3`
         * Pro: Escapes angle brackets in normal text which prevents the
           Obsidian Markdown rendering from breaking
         * Con: Any opening or closing angle bracket will be escaped in code
           blocks as well. It also escapes angle brackets that do not cause
           issues. For example, an arrow (`->`) will be converted to `-\>`.
         * Fix: Manually update any code blocks that contain angle brackets to
           remove the escape characters.

   In my opinion, it is better to set `$keepescape = 1` because that will
   preserve the original text of the note without inserting superfluous escape
   characters that are harder to identify. After the note has been converted to
   Markdown, you can search for [the regex](https://regex101.com/r/hFqTwv/5) in
   VS Code and fix any text that matches the condition described above. It will
   also be visually obvious if a note matches this condition because the
   Obsidian Markdown rendering will break.
1. If code style text is indented with only tabs in OneNote, the Markdown code
   block will lose all indentation. For example, if there is a note with the
   following code block (where `x = 5` is indented with a tab character):
   ```
   def main():
      x = 5
   ```
   it will be converted to:
   ```
   def main():
   x = 5
   ```
   When OneNote is used to export the note to a Word document, it removes the
   tab characters. There is currently no way to prevent this besides replacing
   the tabs with spaces in the note. Spaces will be correctly indented in the
   Markdown file during the conversion process.
1. This is not technically an issue, but any code blocks lacking code style
   formatting in OneNote will not be wrapped with backticks since the script has
   no way of magically knowing what is code and what is normal text.
